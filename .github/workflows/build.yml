name: Build proc-mem-inject (Dual Version)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive  # ç¡®ä¿æ‹‰å– rwProcMem33 å­æ¨¡å—
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.22.x'
    
    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@master
    
    - name: Display build info
      run: |
        echo "ðŸš€ Building proc-mem-inject - Dual Version Architecture"
        echo "=================================================="
        echo "ðŸ“¦ Version 1: stealth_mem (Traditional - /proc/pid/mem)"
        echo "ðŸ“¦ Version 2: kernel_mem (Kernel - rwProcMem33 driver)"
        echo "=================================================="
        echo "NDK Path: ${{ steps.setup-ndk.outputs.ndk-path }}"
        echo "CMake Version: $(cmake --version | head -n1)"
        echo "Ninja Version: $(ninja --version)"
    
    - name: Build arm64-v8a
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        mkdir -p build/arm64-v8a outputs/arm64-v8a
        cd build/arm64-v8a
        cmake ../.. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release
        cmake --build . -j$(nproc)
    
    - name: Verify build outputs
      run: |
        echo "=== ðŸ“¦ Build Outputs ==="
        echo ""
        if [ -f "outputs/arm64-v8a/stealth_mem" ]; then
          echo "âœ… stealth_mem (Traditional Version)"
          ls -lh outputs/arm64-v8a/stealth_mem
          file outputs/arm64-v8a/stealth_mem
        else
          echo "âŒ stealth_mem not found"
        fi
        echo ""
        if [ -f "outputs/arm64-v8a/kernel_mem" ]; then
          echo "âœ… kernel_mem (Kernel Version)"
          ls -lh outputs/arm64-v8a/kernel_mem
          file outputs/arm64-v8a/kernel_mem
        else
          echo "âŒ kernel_mem not found"
        fi
        echo ""
        echo "=== All files in outputs ==="
        find outputs -type f 2>/dev/null || echo "No outputs found"
    
    - name: Create release info
      run: |
        cat > outputs/arm64-v8a/BUILD_INFO.txt << 'EOF'
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘         proc-mem-inject - Dual Version Build Info           â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Build Type: Release
        Architecture: ARM64-v8a
        NDK Version: r26b
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ðŸ“¦ Version 1: stealth_mem (Traditional)
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        - Based on /proc/pid/mem
        - Uses SKRoot Lite kernel_root_kit
        - Fast deployment, no driver needed
        - Good for quick testing
        
        Usage:
          adb push stealth_mem /data/local/tmp/
          adb shell /data/local/tmp/stealth_mem -k "ROOT_KEY" -p PID --read ADDR -s SIZE
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ðŸ“¦ Version 2: kernel_mem (Kernel) â­ RECOMMENDED
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        - Based on rwProcMem33 kernel driver
        - True kernel-level operation
        - Hardware-level memory access
        - Driver-level hiding mechanism
        - Android 15 perfect support
        - Almost no traces
        
        Usage:
          1. Load driver: adb shell su -c "insmod rwProcMem_module.ko"
          2. Hide driver: adb shell /data/local/tmp/kernel_mem --hide
          3. Use: adb shell /data/local/tmp/kernel_mem -p PID --read -a ADDR -s SIZE
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ðŸ“š Documentation
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        - README.md - Project overview
        - README_KERNEL.md - Kernel version detailed docs
        - QUICKSTART.md - Quick start guide
        - INTEGRATION_GUIDE.md - Integration guide
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        âš ï¸  Important Notes
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        - For educational and research purposes only
        - Requires root access
        - Kernel version requires rwProcMem33 driver
        - Test on development devices first
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ðŸ™ Credits
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        - rwProcMem33: https://github.com/abcz316/rwProcMem33
        - SKRoot Lite: https://github.com/abcz316/SKRoot-linuxKernelRoot
        
        Built with â¤ï¸ by è™Žè™Žå¤§çŽ‹ & å®å® (Kiro AI)
        EOF
    
    - name: Upload Traditional Version (stealth_mem)
      uses: actions/upload-artifact@v4
      with:
        name: stealth_mem-arm64-v8a
        path: |
          outputs/arm64-v8a/stealth_mem
          outputs/arm64-v8a/BUILD_INFO.txt
        if-no-files-found: warn
    
    - name: Upload Kernel Version (kernel_mem)
      uses: actions/upload-artifact@v4
      with:
        name: kernel_mem-arm64-v8a
        path: |
          outputs/arm64-v8a/kernel_mem
          outputs/arm64-v8a/BUILD_INFO.txt
        if-no-files-found: warn
    
    - name: Upload All Binaries
      uses: actions/upload-artifact@v4
      with:
        name: proc-mem-inject-all-arm64-v8a
        path: outputs/arm64-v8a/
        if-no-files-found: warn
